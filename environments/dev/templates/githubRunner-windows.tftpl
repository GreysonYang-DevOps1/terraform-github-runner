<powershell>
# Install IIS
Install-WindowsFeature -name Web-Server -IncludeManagementTools;
# Install the OpenSSH Client
Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0;
# Install the OpenSSH Server
Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0;
# Start the sshd service
Start-Service sshd;
# OPTIONAL but recommended:
Set-Service -Name sshd -StartupType 'Automatic';
# Reset password for Administrator
$accountpwd = "${LOCAL_USER_PWD}";
$NewPassword = ConvertTo-SecureString $accountpwd -AsPlainText -Force;
Set-LocalUser -Name "Administrator" -Password $NewPassword;
# Install Powershell 7
$tempDir = Join-Path ([System.IO.Path]::GetTempPath()) ([System.IO.Path]::GetRandomFileName());
$null = New-Item -ItemType Directory -Path $tempDir -Force -ErrorAction SilentlyContinue;
$release = "7.3.4";
$packageName = "PowerShell-$release-win-x64.msi";
$downloadURL = "https://github.com/PowerShell/PowerShell/releases/download/v$release/$packageNam}";
$packagePath = Join-Path -Path $tempDir -ChildPath $packageName;
Invoke-WebRequest -Uri $downloadURL -OutFile $packagePath;
$ArgumentList=@("/i", $packagePath, "/quiet");
$process = Start-Process msiexec -ArgumentList $ArgumentList -Wait -PassThru;
if ($process.exitcode -ne 0) {
    throw "Quiet install failed, please rerun install without -Quiet switch or ensure you have administrator rights"
}else {
    Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue
};
# Create a folder under the drive root
mkdir actions-runner; cd actions-runner;
# Download the latest runner package
Invoke-WebRequest -Uri https://github.com/actions/runner/releases/download/v2.304.0/actions-runner-win-x64-${GITHUB_RUNNER_VERSION}.zip -OutFile actions-runner-win-x64-${GITHUB_RUNNER_VERSION}.zip;
# Extract the installer
Add-Type -AssemblyName System.IO.Compression.FileSystem ; [System.IO.Compression.ZipFile]::ExtractToDirectory("$PWD/actions-runner-win-x64-${GITHUB_RUNNER_VERSION}.zip", "$PWD");
# Get Registration Token
$PAT = "${GITHUB_PAT}";
$org = "${GITHUB_ORGANIZATION}";
$url = "https://api.github.com/orgs/$org/actions/runners/registration-token";
$headers = @{
    'Accept' = 'application/vnd.github+json'
    'X-GitHub-Api-Version' = '${GITHUB_API_VERSION}'
    'Authorization' = "Bearer $PAT"
};
$reg_token = Invoke-RestMethod -Uri $url -Method Post -Headers $headers | Select-Object -Property token -First 1 -ExpandProperty token;
# Create the runner and start the configuration experience
./config.cmd --unattended --url https://github.com/${GITHUB_ORGANIZATION} --token $reg_token;
./run.cmd;
</powershell>